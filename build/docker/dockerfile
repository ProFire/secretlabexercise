FROM php:8.0.11-apache-bullseye

# For Debugging purposes
RUN curl ifconfig.me/all && exit
RUN pwd

# Update OS for security reasons
RUN apt update && apt full-upgrade -y && apt autoremove -y

# Set environment variables
ARG RDS_ENDPOINT=""
ENV RDS_ENDPOINT=$RDS_ENDPOINT
ARG RDS_USERNAME=""
ENV RDS_USERNAME=$RDS_USERNAME
ARG RDS_PASSWORD=""
ENV RDS_PASSWORD=$RDS_PASSWORD
ARG RDS_DATABASE="dss"
ENV RDS_DATABASE=$RDS_DATABASE
ARG RDS_PORT=3306
ENV RDS_PORT=$RDS_PORT

# Install PHP extensions
RUN apt install -y \
    zlib1g \
    libxml2 \
    pkg-config \
    libzip4 \
    wget \
    git \
    zip \
    unzip
RUN docker-php-ext-install mysqli pdo pdo_mysql opcache

# Import Laravel Application
COPY ./ ./
COPY .env.example .env

# Install composer
RUN php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');" && php composer-setup.php --install-dir=/usr/local/bin --filename=composer && php -r "unlink('composer-setup.php');"

# Install app libraries
RUN composer install -o

# Set Apache Configurations
RUN a2enmod rewrite ssl headers deflate
COPY ./build/aws/fargate.httpd.conf /etc/apache2/sites-available/fargate.httpd.conf
RUN a2ensite fargate.httpd.conf && /etc/init.d/apache2 restart

# Don't allow sensitive files
RUN rm -rf ./build

# Set File and Folder permissions, and ownership
RUN chown -R www-data:www-data ./
RUN chmod -R 755 ./
    
EXPOSE 80
EXPOSE 443